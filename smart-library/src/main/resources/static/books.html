<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Sanal KÃ¼tÃ¼phane</title>
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@300;700&display=swap" rel="stylesheet">
    <style>
        /* TASARIM KODLARI (AYNI) */
        body { background: url('https://images.unsplash.com/photo-1521587760476-6c12a4b040da?w=1920') center/cover fixed; color: white; font-family: 'Merriweather', serif; margin: 0; padding: 20px; position: relative; }
        body::before { content: ""; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(44, 30, 20, 0.75); z-index: -1; }
        .header { display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.6); padding: 15px; border-radius: 10px; margin-bottom: 30px; }
        .nav-buttons { display: flex; gap: 10px; }
        button { cursor: pointer; border: none; border-radius: 5px; padding: 8px 15px; font-weight: bold; transition: 0.3s; }
        .btn-primary { background: #d4a373; color: #2c1e14; }
        .btn-primary:hover { background: #faedcd; transform: scale(1.05); }
        .btn-success { background: #28a745; color: white; }
        .btn-success:hover { background: #218838; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-danger:hover { background: #c82333; }
        .btn-info { background: #17a2b8; color: white; } 
        .library-shelf { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 50px 30px; padding: 40px; background: rgba(92, 64, 51, 0.3); border-radius: 15px; backdrop-filter: blur(5px); position: relative; }
        .book-card { width: 150px; height: 240px; position: relative; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); background: linear-gradient(145deg, #3a3a3a, #2d2d2d); border-radius: 8px; box-shadow: 0 8px 20px rgba(0,0,0,0.6), inset 0 1px 0 rgba(255,255,255,0.1); display: flex; flex-direction: column; overflow: visible; border: 1px solid rgba(212, 163, 115, 0.2); }
        .book-card::after { content: ""; position: absolute; bottom: -15px; left: -10px; right: -10px; height: 12px; background: linear-gradient(to bottom, #8b5a2b 0%, #654321 50%, #4a3219 100%); border-radius: 3px; box-shadow: 0 3px 8px rgba(0,0,0,0.5), inset 0 1px 0 rgba(139, 90, 43, 0.5); z-index: -1; }
        .book-cover { width: 100%; height: 100%; object-fit: cover; border-radius: 8px; pointer-events: none; filter: brightness(0.95); transition: filter 0.3s; }
        .book-buttons { position: absolute; top: 100%; left: 0; right: 0; display: flex; flex-direction: column; gap: 5px; opacity: 0; transition: opacity 0.3s; z-index: 10; }
        .book-card:hover { transform: scale(1.3) translateY(-40px) rotateY(5deg); z-index: 100; box-shadow: 0 20px 50px rgba(212, 163, 115, 0.4), 0 10px 30px rgba(0,0,0,0.9); border-color: rgba(212, 163, 115, 0.6); }
        .book-card:hover .book-cover { filter: brightness(1.1); }
        .book-card:hover .book-buttons { opacity: 1; }
        .borrow-btn { background: #28a745; color: white; flex: 1; border: none; cursor: pointer; font-size: 0.8rem; padding: 8px 0; margin: 0; line-height: 1; transition: 0.2s; }
        .borrow-btn:hover { background: #218838; }
        .edit-btn { background: #ffc107; color: black; flex: 1; border: none; cursor: pointer; font-size: 0.8rem; padding: 8px 0; margin: 0; line-height: 1; transition: 0.2s; }
        .edit-btn:hover { background: #e0a800; }
        .delete-btn { background: #dc3545; color: white; flex: 1; border: none; cursor: pointer; font-size: 0.8rem; padding: 8px 0; margin: 0; line-height: 1; transition: 0.2s; }
        .delete-btn:hover { background: #c82333; }
        .book-details { position: absolute; bottom: 0; width: 100%; background: rgba(0,0,0,0.9); padding: 10px; font-size: 0.7em; opacity: 0; transition: 0.3s; }
        .book-card:hover .book-details { opacity: 1; }
        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); justify-content:center; align-items:center; z-index: 1000; }
        .modal-content { background: white; color: black; padding: 25px; border-radius: 10px; width: 500px; max-height: 80vh; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
    </style>
</head>
<body>

    <div class="header">
        <h2>ğŸ“š Sanal KÃ¼tÃ¼phane</h2>
        <div class="nav-buttons">
            <button class="btn-info" onclick="openMyBooksModal()">ğŸ“– KitaplarÄ±m</button>
            <button class="btn-success" onclick="openAddModal()">+ Kitap Ekle</button>
            <button class="btn-primary" id="adminPanelBtn" style="display:none;" onclick="openAdminPanel()">ğŸ‘‘ Admin Panel</button>
            <button class="btn-primary" onclick="openProfileModal()">ğŸ‘¤ Profilim</button>
            <button class="btn-danger" onclick="logout()">Ã‡Ä±kÄ±ÅŸ</button>
        </div>
    </div>

    <div style="margin-bottom: 20px; text-align: center;">
        <button class="btn-primary" onclick="filterBooks('all')">TÃ¼mÃ¼</button>
        <button class="btn-primary" onclick="filterBooks('Roman')">Roman</button>
        <button class="btn-primary" onclick="filterBooks('Bilim Kurgu')">Bilim Kurgu</button>
        <button class="btn-primary" onclick="filterBooks('Tarih')">Tarih</button>
        <button class="btn-primary" onclick="filterBooks('DiÄŸer')">DiÄŸer</button>
        <button class="btn-info" onclick="openStatsModal()">ğŸ“Š Ä°statistikler</button>
    </div>

    <div class="library-shelf" id="shelf"></div>

    <div id="addModal" class="modal">
        <form id="addBookForm" class="modal-content" style="width: 300px;">
            <h3>Yeni Kitap Ekle</h3>
            <input type="text" id="title" placeholder="Kitap AdÄ±" required style="padding:10px;">
            <input type="text" id="author" placeholder="Yazar" required style="padding:10px;">
            <input type="text" id="isbn" placeholder="ISBN" style="padding:10px;">
            <select id="category" style="padding:10px;">
                <option value="Roman">Roman</option>
                <option value="Bilim Kurgu">Bilim Kurgu</option>
                <option value="Tarih">Tarih</option>
                <option value="DiÄŸer">DiÄŸer</option>
            </select>
            <input type="number" id="pageCount" placeholder="Sayfa SayÄ±sÄ±" style="padding:10px;">
            <input type="text" id="imageUrl" placeholder="Resim URL" style="padding:10px;">
            <button type="submit" class="btn-success">Kaydet</button>
            <button type="button" class="btn-danger" onclick="closeAllModals()">Ä°ptal</button>
        </form>
    </div>

    <div id="myBooksModal" class="modal">
        <div class="modal-content">
            <h3>ğŸ“– Ã–dÃ¼nÃ§ AldÄ±klarÄ±m</h3>
            <table>
                <thead>
                    <tr>
                        <th>Kitap</th>
                        <th>AlÄ±ÅŸ Tarihi</th>
                        <th>Durum</th>
                        <th>Ä°ÅŸlem</th>
                    </tr>
                </thead>
                <tbody id="myBooksTableBody"></tbody>
            </table>
            <button class="btn-danger" onclick="closeAllModals()">Kapat</button>
        </div>
    </div>

    <div id="borrowModal" class="modal">
        <div class="modal-content" style="width: 300px; text-align: center;">
            <h3>â³ SÃ¼re SeÃ§iniz</h3>
            <p>Bu kitabÄ± ne kadar sÃ¼reyle Ã¶dÃ¼nÃ§ almak istersiniz?</p>
            
            <select id="borrowDuration" style="width: 100%; padding: 10px; margin-bottom: 15px;">
                <option value="7">1 Hafta (7 GÃ¼n)</option>
                <option value="15">15 GÃ¼n</option>
                <option value="30">1 Ay (30 GÃ¼n)</option>
            </select>
            
            <input type="hidden" id="selectedBookId"> 
            <button class="btn-success" onclick="confirmBorrow()">Onayla ve Al</button>
            <button class="btn-danger" onclick="closeBorrowModal()">Ä°ptal</button>
        </div>
    </div>

    <div id="editModal" class="modal">
        <form id="editBookForm" class="modal-content" style="width: 300px;">
            <h3>ğŸ“ KitabÄ± DÃ¼zenle</h3>
            <input type="text" id="editTitle" placeholder="Kitap AdÄ±" required style="padding:10px;">
            <input type="text" id="editAuthor" placeholder="Yazar" required style="padding:10px;">
            <input type="text" id="editIsbn" placeholder="ISBN" style="padding:10px;">
            <select id="editCategory" style="padding:10px;">
                <option value="Roman">Roman</option>
                <option value="Bilim Kurgu">Bilim Kurgu</option>
                <option value="Tarih">Tarih</option>
                <option value="DiÄŸer">DiÄŸer</option>
            </select>
            <input type="number" id="editPageCount" placeholder="Sayfa SayÄ±sÄ±" style="padding:10px;">
            <input type="text" id="editImageUrl" placeholder="Resim URL" style="padding:10px;">
            <input type="number" id="editStock" placeholder="Stok" min="0" required style="padding:10px;">
            <input type="hidden" id="editBookId">
            <button type="submit" class="btn-success">Kaydet</button>
            <button type="button" class="btn-danger" onclick="closeAllModals()">Ä°ptal</button>
        </form>
    </div>

    <div id="statsModal" class="modal">
        <div class="modal-content" style="width: 400px;">
            <h3>ğŸ“Š KÃ¼tÃ¼phane Ä°statistikleri</h3>
            <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <div style="font-size: 1.3em; margin-bottom: 10px;">
                    <strong>ğŸ“š Toplam Kitap SayÄ±sÄ±:</strong> <span id="totalBooks" style="color: #dc3545;">0</span>
                </div>
                <div style="font-size: 1.3em;">
                    <strong>ğŸ“¦ Toplam Stok:</strong> <span id="totalStock" style="color: #dc3545;">0</span>
                </div>
            </div>
            
            <h4 style="margin-top: 20px; margin-bottom: 10px;">Kategoriye GÃ¶re DaÄŸÄ±lÄ±m:</h4>
            <table style="width: 100%;">
                <thead>
                    <tr style="background: rgba(212, 163, 115, 0.3);">
                        <th style="padding: 8px;">Kategori</th>
                        <th style="padding: 8px; text-align: right;">Kitap SayÄ±sÄ±</th>
                        <th style="padding: 8px; text-align: right;">Stok SayÄ±sÄ±</th>
                    </tr>
                </thead>
                <tbody id="categoryTable"></tbody>
            </table>
            
            <button class="btn-danger" onclick="closeAllModals()" style="width: 100%; margin-top: 15px;">Kapat</button>
        </div>
    </div>

    <div id="profileModal" class="modal">
        <div class="modal-content" style="width: 500px;">
            <h3>ğŸ‘¤ Profil Bilgileri</h3>
            
            <div style="background: rgba(0,0,0,0.1); padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <div style="margin-bottom: 15px;">
                    <strong>Ad Soyad:</strong> <span id="profileName" style="color: #dc3545;"></span>
                </div>
                <div style="margin-bottom: 15px;">
                    <strong>Email:</strong> <span id="profileEmail" style="color: #dc3545;"></span>
                </div>
                <div>
                    <strong>Rol:</strong> <span id="profileRole" style="color: #dc3545;"></span>
                </div>
            </div>

            <button class="btn-danger" onclick="deleteOwnAccount()" style="width: 100%; margin-bottom: 10px;">ğŸ—‘ï¸ HesabÄ± Sil</button>
            <button class="btn-primary" onclick="closeAllModals()" style="width: 100%;">Kapat</button>
        </div>
    </div>

    <div id="adminModal" class="modal">
        <div class="modal-content" style="width: 800px;">
            <h3>ğŸ‘‘ Admin Panel</h3>
            
            <div style="margin-bottom: 20px;">
                <button class="btn-primary" onclick="showAdminUsers()">ğŸ‘¥ KullanÄ±cÄ±lar</button>
                <button class="btn-info" onclick="showAdminBorrows()">ğŸ“š Ã–dÃ¼nÃ§ Ä°ÅŸlemleri</button>
                <button class="btn-success" onclick="fixBookCategories()">ğŸ”§ Kategorileri DÃ¼zelt</button>
            </div>
            
            <div id="adminContent" style="max-height: 500px; overflow-y: auto;">
                <p style="text-align: center; color: #666;">YukarÄ±daki butonlardan birini seÃ§in</p>
            </div>
            
            <button class="btn-danger" onclick="closeAllModals()" style="width: 100%; margin-top: 15px;">Kapat</button>
        </div>
    </div>

    <script>
        const API_URL = "http://localhost:8082/api/v1/books";
        const BORROW_URL = "http://localhost:8082/api/v1/borrow"; 
        let allBooks = [];

        // --- TOKEN Ã‡Ã–ZÃœCÃœ ---
        function parseJwt (token) {
            try {
                var base64Url = token.split('.')[1];
                var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                return JSON.parse(jsonPayload);
            } catch (e) {
                return null;
            }
        }

        // 1. KÄ°TAPLARI GETÄ°R (HATA AYIKLAMA MODU ğŸ•µï¸â€â™‚ï¸)
        async function fetchBooks() {
            const token = localStorage.getItem('jwt_token');
            
            // EÄŸer hiÃ§ token yoksa mecbur atacak.
            if(!token) { 
                alert("GiriÅŸ yapmamÄ±ÅŸsÄ±n, ana sayfaya yÃ¶nlendiriliyorsun.");
                window.location.href = 'index.html'; 
                return; 
            }

            try {
                const response = await fetch(API_URL, { headers: { 'Authorization': 'Bearer ' + token } });
                
                if(response.ok) {
                    allBooks = await response.json();
                    renderBooks(allBooks);
                    
                    // Admin panel butonunu gÃ¶ster
                    const userPayload = parseJwt(token);
                    if (userPayload && userPayload.role === 'ADMIN') {
                        document.getElementById('adminPanelBtn').style.display = 'inline-block';
                    }
                } else {
                    // ğŸš¨ BURAYI DEÄÄ°ÅTÄ°RDÄ°M: ArtÄ±k seni siteden atmÄ±yor!
                    const errText = await response.text();
                    
                    // Ekrana kocaman hata basÄ±yoruz:
                    alert("HATA ALDIN KANKA!\n\nHata Kodu: " + response.status + "\nMesaj: " + errText);
                    
                    // logout(); // <-- Bunu kapattÄ±m, artÄ±k kapanmayacak.
                }
            } catch (err) { 
                console.error("Sunucu hatasÄ±", err); 
                alert("Sunucuya baÄŸlanÄ±lamÄ±yor! Backend (Java) Ã§alÄ±ÅŸÄ±yor mu?");
            }
        }

        // 2. KÄ°TAPLARI LÄ°STELE
        function renderBooks(books) {
            const shelf = document.getElementById('shelf');
            const token = localStorage.getItem('jwt_token');
            const userPayload = parseJwt(token);
            const userEmail = userPayload ? userPayload.sub : null;
            const userRole = userPayload ? userPayload.role : null;
            const isAdmin = userRole === 'ADMIN';
            
            shelf.innerHTML = "";
            books.forEach(book => {
                const img = book.imageUrl ? book.imageUrl : 'https://via.placeholder.com/150x240?text=Kitap';
                const stockMsg = book.stock > 0 ? `Stok: ${book.stock}` : 'TÃœKENDÄ° âŒ';
                const btnDisabled = book.stock > 0 ? '' : 'disabled style="background:gray;"';
                
                // Admin veya kitabÄ± ekleyen kiÅŸi edit butonunu gÃ¶rebilir
                const isCreator = book.createdBy && book.createdBy === userEmail;
                const canEdit = isAdmin || isCreator;
                const editBtn = canEdit ? `<button class="edit-btn" onclick="openEditModal(${book.id})">âœï¸ DÃ¼zenle</button>` : '';
                
                // Sadece admin kitap silebilir
                const deleteBtn = isAdmin ? `<button class="delete-btn" onclick="deleteBook(${book.id})">ğŸ—‘ï¸ Sil</button>` : '';

                shelf.innerHTML += `
                    <div class="book-card">
                        <img src="${img}" class="book-cover">
                        <div class="book-details">
                            <div style="font-weight:bold; color:#faedcd;">${book.title}</div>
                            <div>${book.author}</div>
                            <div style="color:yellow;">${stockMsg}</div>
                        </div>
                        <div class="book-buttons">
                            <button class="borrow-btn" ${btnDisabled} onclick="openBorrowModal(${book.id})">
                                ${book.stock > 0 ? 'ğŸ“š Ã–dÃ¼nÃ§ Al' : 'Stok Yok'}
                            </button>
                            ${editBtn}
                            ${deleteBtn}
                        </div>
                    </div>
                `;
            });
        }

        // 3. Ã–DÃœNÃ‡ ALMA SÄ°STEMÄ°
        function openBorrowModal(bookId) {
            document.getElementById('selectedBookId').value = bookId;
            document.getElementById('borrowModal').style.display = 'flex';
        }

        function closeBorrowModal() {
            document.getElementById('borrowModal').style.display = 'none';
        }

        async function confirmBorrow() {
            const bookId = document.getElementById('selectedBookId').value;
            const days = document.getElementById('borrowDuration').value;
            const token = localStorage.getItem('jwt_token');

            // Token'dan email'i Ã§ekiyoruz
            const userPayload = parseJwt(token);
            const userEmail = userPayload ? userPayload.sub : null; 

            if (!userEmail) { alert("KullanÄ±cÄ± bilgisi bulunamadÄ±!"); return; }

            try {
                // Backend: POST /api/v1/borrow/{bookId}?days={days}
                const url = `${BORROW_URL}/${bookId}?days=${days}`;

                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + token }
                });

                const msg = await response.text();
                alert(msg); 
                
                closeBorrowModal();
                fetchBooks(); // Stok gÃ¼ncellensin diye yenile
            } catch (error) {
                console.error("Hata:", error);
                alert("Ä°ÅŸlem baÅŸarÄ±sÄ±z!");
            }
        }

        // 4. KÄ°TAPLARIM & Ä°ADE
        async function openMyBooksModal() {
            const token = localStorage.getItem('jwt_token');
            const userPayload = parseJwt(token);
            const email = userPayload.sub;

            const response = await fetch(`${BORROW_URL}/my-books?email=${email}`, {
                headers: { 'Authorization': 'Bearer ' + token }
            });
            const myBooks = await response.json();
            
            const tbody = document.getElementById('myBooksTableBody');
            tbody.innerHTML = "";

            myBooks.forEach(borrow => {
                const isReturned = borrow.returnDate !== null;
                const status = isReturned ? "âœ… Ä°ade Edildi" : "â³ Okunuyor";
                const actionBtn = isReturned ? "-" : 
                    `<button class="btn-primary" style="font-size:0.8rem;" onclick="returnBook(${borrow.id})">Ä°ade Et</button>`;
                
                tbody.innerHTML += `
                    <tr>
                        <td>${borrow.book.title}</td>
                        <td>${borrow.borrowDate} <br> <small>(Son: ${borrow.dueDate})</small></td>
                        <td>${status}</td>
                        <td>${actionBtn}</td>
                    </tr>
                `;
            });
            document.getElementById('myBooksModal').style.display = 'flex';
        }

        async function returnBook(borrowId) {
            if(!confirm("KitabÄ± iade ediyorsunuz. Emin misiniz?")) return;
            const token = localStorage.getItem('jwt_token');
            
            const response = await fetch(`${BORROW_URL}/return/${borrowId}`, {
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + token }
            });
            const msg = await response.text();
            alert(msg);
            closeAllModals();
            fetchBooks();
        }

        // 5. KÄ°TAP EKLEME
        document.getElementById('addBookForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const token = localStorage.getItem('jwt_token');
            const newBook = {
                title: document.getElementById('title').value,
                author: document.getElementById('author').value,
                stock: 5, // VarsayÄ±lan stok
                category: document.getElementById('category').value,
                imageUrl: document.getElementById('imageUrl').value
            };
            try {
                const resp = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
                    body: JSON.stringify(newBook)
                });

                if (resp.ok) {
                    alert("Kitap Eklendi!");
                } else {
                    const txt = await resp.text();
                    alert("Kitap eklenemedi: " + resp.status + " - " + txt);
                }
            } catch (err) {
                console.error('Kitap ekleme hatasÄ±:', err);
                alert('Kitap eklenirken hata oluÅŸtu. Konsolu kontrol edin.');
            }
            closeAllModals();
            fetchBooks();
        });

        // YARDIMCILAR
        function filterBooks(cat) {
            if(cat==='all') renderBooks(allBooks);
            else renderBooks(allBooks.filter(b => b.category === cat));
        }
        function openAddModal() { document.getElementById('addModal').style.display = 'flex'; }
        
        // Edit ModalÄ± FonksiyonlarÄ±
        function openEditModal(bookId) {
            const book = allBooks.find(b => b.id === bookId);
            if (!book) {
                alert("Kitap bulunamadÄ±!");
                return;
            }
            
            document.getElementById('editTitle').value = book.title;
            document.getElementById('editAuthor').value = book.author;
            document.getElementById('editIsbn').value = book.isbn;
            document.getElementById('editCategory').value = book.category;
            document.getElementById('editPageCount').value = book.pageCount;
            document.getElementById('editImageUrl').value = book.imageUrl;
            document.getElementById('editStock').value = book.stock;
            document.getElementById('editBookId').value = bookId;
            
            document.getElementById('editModal').style.display = 'flex';
        }

        document.getElementById('editBookForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const token = localStorage.getItem('jwt_token');
            const bookId = document.getElementById('editBookId').value;
            
            const updatedBook = {
                title: document.getElementById('editTitle').value,
                author: document.getElementById('editAuthor').value,
                isbn: document.getElementById('editIsbn').value,
                category: document.getElementById('editCategory').value,
                pageCount: parseInt(document.getElementById('editPageCount').value),
                imageUrl: document.getElementById('editImageUrl').value,
                stock: parseInt(document.getElementById('editStock').value)
            };
            
            try {
                const resp = await fetch(`${API_URL}/${bookId}`, {
                    method: 'PUT',
                    headers: { 
                        'Authorization': 'Bearer ' + token, 
                        'Content-Type': 'application/json' 
                    },
                    body: JSON.stringify(updatedBook)
                });

                if (resp.ok) {
                    alert("Kitap baÅŸarÄ±yla gÃ¼ncellendi!");
                } else {
                    const txt = await resp.text();
                    alert("GÃ¼ncelleme baÅŸarÄ±sÄ±z: " + resp.status + " - " + txt);
                }
            } catch (err) {
                console.error('Kitap gÃ¼ncelleme hatasÄ±:', err);
                alert('GÃ¼ncelleme sÄ±rasÄ±nda hata oluÅŸtu.');
            }
            closeAllModals();
            fetchBooks();
        });

        // KÄ°TAP SÄ°LME FONKSÄ°YONU (Sadece Admin)
        async function deleteBook(bookId) {
            if (!confirm("Bu kitabÄ± silmek istediÄŸinize emin misiniz?")) {
                return;
            }

            const token = localStorage.getItem('jwt_token');
            
            if (!token) {
                alert("Oturum sÃ¼reniz dolmuÅŸ, lÃ¼tfen tekrar giriÅŸ yapÄ±n.");
                window.location.href = "index.html";
                return;
            }

            try {
                const response = await fetch(`${API_URL}/${bookId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': 'Bearer ' + token }
                });

                if (response.ok) {
                    alert("Kitap baÅŸarÄ±yla silindi!");
                    fetchBooks();
                } else {
                    const txt = await response.text();
                    alert("Silme baÅŸarÄ±sÄ±z: " + response.status + " - " + txt);
                }
            } catch (err) {
                console.error('Kitap silme hatasÄ±:', err);
                alert('Silme sÄ±rasÄ±nda hata oluÅŸtu.');
            }
        }
        
        function closeAllModals() { 
            document.getElementById('addModal').style.display = 'none'; 
            document.getElementById('myBooksModal').style.display = 'none'; 
            document.getElementById('borrowModal').style.display = 'none';
            document.getElementById('statsModal').style.display = 'none';
            document.getElementById('editModal').style.display = 'none';
            document.getElementById('adminModal').style.display = 'none';
            document.getElementById('profileModal').style.display = 'none';
        }
        function logout() { localStorage.removeItem('jwt_token'); window.location.href = 'index.html'; }

        // --- PROFIL MODAL AÃ‡MA ---
        async function openProfileModal() {
            const token = localStorage.getItem('jwt_token');
            
            try {
                const response = await fetch('http://localhost:8082/api/v1/users/profile', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });

                if (response.ok) {
                    const user = await response.json();
                    document.getElementById('profileName').textContent = user.name;
                    document.getElementById('profileEmail').textContent = user.email;
                    document.getElementById('profileRole').textContent = user.role === 'ADMIN' ? 'ğŸ‘‘ Admin' : 'ğŸ‘¤ KullanÄ±cÄ±';
                    
                    document.getElementById('profileModal').style.display = 'flex';
                } else {
                    alert('Profil bilgileri yÃ¼klenemedi!');
                }
            } catch (err) {
                console.error('Hata:', err);
                alert('Sunucu hatasÄ±!');
            }
        }

        // --- HESAP SÄ°LME ---
        async function deleteOwnAccount() {
            if (!confirm('âš ï¸ DÄ°KKAT! HesabÄ±nÄ±zÄ± silmek istediÄŸinize emin misiniz? Bu iÅŸlem geri alÄ±namaz!')) {
                return;
            }

            const token = localStorage.getItem('jwt_token');
            
            try {
                const response = await fetch('http://localhost:8082/api/v1/users/delete-account', {
                    method: 'DELETE',
                    headers: { 'Authorization': 'Bearer ' + token }
                });

                if (response.ok) {
                    alert('HesabÄ±nÄ±z silindi. YÃ¶nlendiriliyorsunuz...');
                    logout();
                } else {
                    const error = await response.text();
                    alert('HATA: ' + error);
                }
            } catch (err) {
                console.error('Hata:', err);
                alert('Sunucu hatasÄ±!');
            }
        }

        // --- ADMIN: KULLANICI SÄ°LME ---
        async function deleteUser(userId) {
            if (!confirm('Bu kullanÄ±cÄ±yÄ± silmek istediÄŸinize emin misiniz?')) {
                return;
            }

            const token = localStorage.getItem('jwt_token');
            
            try {
                const response = await fetch('http://localhost:8082/api/v1/users/' + userId, {
                    method: 'DELETE',
                    headers: { 'Authorization': 'Bearer ' + token }
                });

                if (response.ok) {
                    alert('KullanÄ±cÄ± silindi!');
                    showAdminUsers(); // Listeyi yenile
                } else {
                    const error = await response.text();
                    alert('HATA: ' + error);
                }
            } catch (err) {
                console.error('Hata:', err);
                alert('Sunucu hatasÄ±!');
            }
        }

        // Admin Panel FonksiyonlarÄ±
        function openAdminPanel() {
            document.getElementById('adminModal').style.display = 'flex';
        }

        async function showAdminUsers() {
            const token = localStorage.getItem('jwt_token');
            const adminContent = document.getElementById('adminContent');
            adminContent.innerHTML = '<p style="text-align:center;">YÃ¼kleniyor...</p>';

            try {
                const response = await fetch('http://localhost:8082/api/v1/users', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });

                if (response.ok) {
                    const users = await response.json();
                    let html = '<h4>ğŸ‘¥ KayÄ±tlÄ± KullanÄ±cÄ±lar</h4><table style="width:100%;"><thead><tr><th>ID</th><th>Ä°sim</th><th>Email</th><th>Rol</th><th>KayÄ±t Tarihi</th><th>Ä°ÅŸlem</th></tr></thead><tbody>';
                    
                    users.forEach(user => {
                        const roleText = user.role === 'ADMIN' ? 'ğŸ‘‘ Admin' : 'ğŸ‘¤ User';
                        const date = user.createdAt ? new Date(user.createdAt).toLocaleDateString('tr-TR') : '-';
                        html += `<tr>
                            <td>${user.id}</td>
                            <td>${user.name}</td>
                            <td>${user.email}</td>
                            <td>${roleText}</td>
                            <td>${date}</td>
                            <td><button class="btn-danger" onclick="deleteUser(${user.id})" style="padding:5px 10px; font-size:0.8em;">Sil</button></td>
                        </tr>`;
                    });
                    
                    html += '</tbody></table>';
                    adminContent.innerHTML = html;
                } else {
                    adminContent.innerHTML = '<p style="color:red;">Yetkiniz yok veya hata oluÅŸtu!</p>';
                }
            } catch (err) {
                console.error(err);
                adminContent.innerHTML = '<p style="color:red;">Sunucu hatasÄ±!</p>';
            }
        }

        async function showAdminBorrows() {
            const token = localStorage.getItem('jwt_token');
            const adminContent = document.getElementById('adminContent');
            adminContent.innerHTML = '<p style="text-align:center;">YÃ¼kleniyor...</p>';

            try {
                const response = await fetch('http://localhost:8082/api/v1/internal/borrows', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });

                if (response.ok) {
                    const borrows = await response.json();
                    let html = '<h4>ğŸ“š TÃ¼m Ã–dÃ¼nÃ§ Ä°ÅŸlemleri</h4><table style="width:100%;"><thead><tr><th>KullanÄ±cÄ±</th><th>Kitap</th><th>AlÄ±ÅŸ Tarihi</th><th>Son Tarih</th><th>Ä°ade Tarihi</th><th>Durum</th></tr></thead><tbody>';
                    
                    borrows.forEach(borrow => {
                        const status = borrow.returnDate ? 'âœ… Ä°ade Edildi' : 'â³ Okunuyor';
                        const returnDate = borrow.returnDate ? new Date(borrow.returnDate).toLocaleDateString('tr-TR') : '-';
                        html += `<tr>
                            <td>${borrow.user.name} (${borrow.user.email})</td>
                            <td>${borrow.book.title}</td>
                            <td>${borrow.borrowDate}</td>
                            <td>${borrow.dueDate}</td>
                            <td>${returnDate}</td>
                            <td>${status}</td>
                        </tr>`;
                    });
                    
                    html += '</tbody></table>';
                    adminContent.innerHTML = html;
                } else {
                    adminContent.innerHTML = '<p style="color:red;">Yetkiniz yok veya hata oluÅŸtu!</p>';
                }
            } catch (err) {
                console.error(err);
                adminContent.innerHTML = '<p style="color:red;">Sunucu hatasÄ±!</p>';
            }
        }

        async function fixBookCategories() {
            const token = localStorage.getItem('jwt_token');
            
            if (!confirm('Kategorisi olmayan tÃ¼m kitaplar "DiÄŸer" kategorisine atanacak. OnaylÄ±yor musunuz?')) {
                return;
            }

            try {
                const response = await fetch('http://localhost:8082/api/v1/internal/fix-categories', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + token }
                });

                if (response.ok) {
                    const message = await response.text();
                    alert('âœ… ' + message);
                    fetchBooks(); // KitaplarÄ± yenile
                } else {
                    alert('âŒ Ä°ÅŸlem baÅŸarÄ±sÄ±z!');
                }
            } catch (err) {
                console.error(err);
                alert('âŒ Sunucu hatasÄ±!');
            }
        }

        // Ä°statistikler ModalÄ±
        async function openStatsModal() {
            const token = localStorage.getItem('jwt_token');
            
            if (!token) {
                alert("Oturum sÃ¼reniz dolmuÅŸ, lÃ¼tfen tekrar giriÅŸ yapÄ±n.");
                window.location.href = "index.html";
                return;
            }

            try {
                const response = await fetch("http://localhost:8082/api/v1/books/stats/total-stock", {
                    headers: { 'Authorization': 'Bearer ' + token }
                });

                if (response.ok) {
                    const stats = await response.json();
                    
                    document.getElementById('totalBooks').textContent = stats.totalBooks;
                    document.getElementById('totalStock').textContent = stats.totalStock;
                    
                    const categoryTable = document.getElementById('categoryTable');
                    categoryTable.innerHTML = "";
                    
                    const categories = stats.byCategory;
                    const stockByCategory = stats.stockByCategory;
                    for (const [category, count] of Object.entries(categories)) {
                        const stock = stockByCategory[category] || 0;
                        const row = document.createElement('tr');
                        row.style.borderBottom = '1px solid rgba(212, 163, 115, 0.3)';
                        row.innerHTML = `
                            <td style="padding: 8px; text-align: left;">${category}</td>
                            <td style="padding: 8px; text-align: right; color: #dc3545; font-weight: bold;">${count}</td>
                            <td style="padding: 8px; text-align: right; color: #28a745; font-weight: bold;">${stock}</td>
                        `;
                        categoryTable.appendChild(row);
                    }
                    
                    document.getElementById('statsModal').style.display = 'flex';
                } else {
                    alert("Ä°statistikler yÃ¼klenirken hata oluÅŸtu!");
                }
            } catch (error) {
                console.error("Ä°statistik hatasÄ±:", error);
                alert("Sunucuya baÄŸlanÄ±rken bir hata oluÅŸtu.");
            }
        }

        // BAÅLAT
        fetchBooks(); 
    </script>
</body>
</html>